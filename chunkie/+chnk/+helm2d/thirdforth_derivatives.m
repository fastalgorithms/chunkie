function [hess, third, forth] = thirdforth_derivatives(k,src,targ)
%CHNK.HELM2D.GREEN evaluate the second, third, and forth derivatives of
% helmholtz green's function: i/4 H_0^1(k|x-y|).
% for the given sources and targets

% the third derivatives are: (listed in order)
% G_{x1x1y1}, G_{x1x1y2}, G_{x1x2y1}, G_{x1x2y2}, G_{x2x2y1}, G_{x2x2y2} 
%
% forth derivatives are: 
%G_{x1x1x1y1}, G_{x1x1x1y2}, G_{x1x1x2y1}, G_{x1x1x2y2}, G_{x1x2x2y1},
%G_{x1x2x2y2}, G_{x2x2x2y1}, G_{x2x2x2y2}

[~,ns] = size(src);
[~,nt] = size(targ);

xs = repmat(src(1,:),nt,1);
ys = repmat(src(2,:),nt,1);

xt = repmat(targ(1,:).',1,ns);
yt = repmat(targ(2,:).',1,ns);

rx = xt-xs;
ry = yt-ys;

rx2 = rx.*rx;
ry2 = ry.*ry;

r2 = rx2+ry2;

r = sqrt(r2);

[m,n] = size(xs);

if nargout > 0
    h0 = besselh(0,1,k*r);
    hess = zeros(m,n,3);
    h1 = besselh(1,1,k*r); 
    r3 = r.^3;
    
    h2 = 2*h1./(k*r)-h0;
    
    hess(:,:,1) = 0.25*1i*k*((rx-ry).*(rx+ry).*h1./r3 - k*rx2.*h0./r2);
    hess(:,:,2) = 0.25*1i*k*k*rx.*ry.*h2./r2;
    hess(:,:,3) = 0.25*1i*k*((ry-rx).*(rx+ry).*h1./r3 - k*ry2.*h0./r2);
end


if nargout > 1
    h3 = besselh(0,1,k*r) - besselh(2, 1, k*r);
    h4 = h1 - besselh(3, 1, k*r);

    third = zeros(m,n,6);
    
    third(:,:,1) = 3i*k*0.25*h1.*(rx.^3)./(r.^5) - 3i*k*0.25*rx.*h1./(r.^3) - ...
        3i*(k^2)*0.25*(rx.^3).*h3./(2*r.^4) + 3i*(k^2)*0.25.*rx.*h3./(2*r.^2) - 1i*(k^3)*0.25*(rx.^3).*h1./(2*r.^3) -...
        1i*(k^3)*0.25.*(rx.^3).*h4./(4*r.^3);

    third(:,:,2) = 3i*k*0.25*(rx.^2).*ry.*h1./(r.^5) - 1i*0.25*k.*ry.*h1./(r.^3) - ...
        (1i)*(0.25)*3*(k^2)*(rx.^2).*(ry).*h3./(2*r.^4) + 1i*(k^2)*0.25*ry.*h3./(2*r.^2) - ...
        1i*(k^3)*0.25*(rx.^2).*ry.*h1./(2*r.^3) - 1i*(k^3)*0.25*(rx.^2).*ry.*h4./(4*r.^3);
    
    third(:,:, 3) = 3i*k*0.25*(rx.^2).*ry.*h1./(r.^5) - 1i*0.25*k.*ry.*h1./(r.^3) - ...
        (1i)*(0.25)*3*(k^2)*(rx.^2).*(ry).*h3./(2*r.^4) + 1i*(k^2)*0.25*ry.*h3./(2*r.^2) - ...
        1i*(k^3)*0.25*(rx.^2).*ry.*h1./(2*r.^3) - 1i*(k^3)*0.25*(rx.^2).*ry.*h4./(4*r.^3);

    third(:, :, 4) = -1i*k*0.25*rx.*h1./(r.^3) + 3i*k*0.25.*rx.*(ry.^2).*h1./(r.^5) + ...
        1i*(k^2).*rx.*h3./(8*r.^2) - 3i*(k^2).*rx.*(ry.^2).*h3./(8*r.^4) - ...
        1i*(k^3).*(rx).*(ry.^2).*h1./(8*r.^3) - 1i*(k^3)*rx.*(ry.^2).*h4./(16*r.^3);

    third(:, :, 5) = -1i*k*0.25.*rx.*h1./(r.^3) + 3i*k*0.25.*rx.*(ry.^2).*h1./(r.^5) + ...
        1i*(k^2).*rx.*h3./(8*r.^2) - 3i*(k^2).*rx.*(ry.^2).*h3./(8*r.^4) - ...
        1i*(k^3).*(rx).*(ry.^2).*h1./(8*r.^3) - 1i*(k^3)*rx.*(ry.^2).*h4./(16*r.^3);
    
    third(:, :, 6) = -3i*k*0.25.*ry.*h1./(r.^3) + 3i*0.25*k*(ry.^3).*h1./(r.^5) + ...
      3i*0.25*(k^2)*ry.*h3./(2*r.^2) - 3i*(k^2)*(0.25)*(ry.^3).*h3./(2*r.^4) - ...
      1i*(0.25)*(k^3).*(ry.^3).*h1./(2*r.^3) - 1i*(k^3)*0.25.*(ry.^3).*h4./(4*r.^3);
end

if nargout > 2
    h5 = besselh(2, 1, k*r) - besselh(4, 1, k*r);

    forth = zeros(m,n,8);
    
    forth(:, :, 1) = 0.25*(1i)*(-15)*k.*(rx.^4).*h1./(r.^7) + 0.25*(1i)*18*k*(rx.^2).*h1./(r.^5)-...
        3*(1i)*(0.25)*k*h1./(r.^3) + 0.25*(1i)*(15*k^2).*(rx.^4).*h3./(2*r.^6) - ...
        (1i)*(0.25)*9*(k^2)*(rx.^2).*h3./(r.^4) + (1i)*(0.25)*3*(k^2).*h3./(2*r.^2)+...
        (1i)*(0.25)*(k^3)*(rx.^4).*h1./(r.^5) + (1i)*(0.25)*(k^3)*(rx.^4).*h4./(2*r.^5) + ...
        -(1i)*(0.25)*(k^3)*(rx.^2).*h1./(r.^3) - (1i)*(0.25)*(k^3)*(rx.^2).*h4./(2*r.^3) +...
        (1i)*(0.25)*(3*k^3)*(rx.^4).*h1./(2*r.^5) + (1i)*(0.25)*(3*k^3)*(rx.^4).*h4./(4*r.^5) -...
        (1i)*(0.25)*(3*k^3)*(rx.^2).*h1./(2*r.^3) - (1i)*(0.25)*(3*k^3)*(rx.^2).*h4./(4*r.^3) +...
        (1i)*(0.25)*(0.5)*(k^3)*(rx.^4).*h1./(r.^5) - (1i)*(0.25)*(0.5)*(k^3)*(rx.^2).*h1./(r.^3)-...
        (1i)*(0.25)*(0.5)*(k^4)*(rx.^4).*h3./(2*r.^4) + (1i)*(0.25)*(0.5)*(k^3)*(rx.^4).*h4./(2*r.^5) -... 
        (1i)*(0.25)*(0.5)*(k^3)*(rx.^2).*h4./(2*r.^3) + (1i)*0.25*(0.5)*(k^4)*(-rx.^4).*h3./(4*r.^4) +...
        (1i)*0.25*(0.5)*(k^4)*(rx.^4).*h5./(4*r.^4);

    forth(:, :, 2) = (0.25)*(1i)*(-15)*k.*(rx.^3).*(ry).*h1./(r.^7) + 0.25*(1i)*9*k*(rx.*ry).*h1./(r.^5)  + ...
        (0.25)*(1i)*(15)*(k^2).*(rx.^3).*(ry).*(h3)./(2*r.^6) - (0.25)*(1i)*9*(k^2)*(rx.*ry).*h3./(2*r.^4) -...
        ((0.25)*(1i)*(k^3)*(-rx.^3).*(ry).*h1./(r.^5) + 0.25*(1i)*(k^3)*(-rx.^3).*ry.*h4./(2*r.^5)) + ...
        (0.25)*(1i)*(3*k^3).*(rx.^3).*ry.*h1./(2*r.^5) + (0.25)*(1i)*(3*k^3).*(rx.^3).*ry.*h4./(4*r.^5) -...
        (0.25)*(1i)*(3*k^3)*(rx.*ry).*h1./(2*r.^3) -(0.25)*(1i)*(3*k^3).*(rx.*ry).*h4./(4*r.^3) +...
        (0.25)*(1i)*(k^3)*(rx.^3).*ry.*h1./(2*r.^5) - (0.25)*(1i)*(k^4).*(rx.^3).*ry.*h3./(4*r.^4) + ...
        (0.25)*(1i)*(k^3)*(rx.^3).*ry.*h4./(4*r.^5) + (0.25)*(1i)*(k^4).*(rx.^3).*(-ry).*h3./(8*r.^4) + ...
        (0.25)*(1i)*(k^4)*(rx.^3).*ry.*h5./(8*r.^4);

    forth(:, :, 3) = (0.25)*(1i)*(-15)*k.*(rx.^3).*(ry).*h1./(r.^7) + 0.25*(1i)*9*k*(rx.*ry).*h1./(r.^5)  + ...
        (0.25)*(1i)*(15)*(k^2).*(rx.^3).*(ry).*(h3)./(2*r.^6) - (0.25)*(1i)*9*(k^2)*(rx.*ry).*h3./(2*r.^4) -...
        ((0.25)*(1i)*(k^3)*(-rx.^3).*(ry).*h1./(r.^5) + 0.25*(1i)*(k^3)*(-rx.^3).*ry.*h4./(2*r.^5)) + ...
        (0.25)*(1i)*(3*k^3).*(rx.^3).*ry.*h1./(2*r.^5) + (0.25)*(1i)*(3*k^3).*(rx.^3).*ry.*h4./(4*r.^5) -...
        (0.25)*(1i)*(3*k^3)*(rx.*ry).*h1./(2*r.^3) -(0.25)*(1i)*(3*k^3).*(rx.*ry).*h4./(4*r.^3) +...
        (0.25)*(1i)*(k^3)*(rx.^3).*ry.*h1./(2*r.^5) - (0.25)*(1i)*(k^4).*(rx.^3).*ry.*h3./(4*r.^4) + ...
        (0.25)*(1i)*(k^3)*(rx.^3).*ry.*h4./(4*r.^5) + (0.25)*(1i)*(k^4).*(rx.^3).*(-ry).*h3./(8*r.^4) + ...
        (0.25)*(1i)*(k^4)*(rx.^3).*ry.*h5./(8*r.^4);

    forth(:, :, 4) = (0.25)*(1i)*(3*k)*(rx.^2).*h1./(r.^5) -(0.25)*(1i)*k.*h1./(r.^3) - ...
       (0.25)*(1i)*15*k.*(rx.^2).*(ry.^2).*(h1)./(r.^7) + (0.25)*(1i)*(3*k).*(ry.^2).*h1./(r.^5)-...
       (0.25)*(1i)*(3*k^2).*(rx.^2).*h3./(2*r.^4) + (0.25)*(1i)*(k^2).*h3./(2*r.^2) +...
       (0.25)*(1i)*15*(k^2).*(rx.^2).*(ry.^2).*h3./(2*r.^6) - (0.25)*(1i)*(3*k^2)*(ry.^2).*h3./(2*r.^4) -...
       ((0.25)*(1i)*(k^3).*(-rx.^2).*(ry.^2).*h1./(r.^5) + (0.25)*(1i)*(k^3).*(-rx.^2).*(ry.^2).*h4./(2*r.^5)) +...
       (0.25)*(1i)*(3*k^3).*(rx.^2).*(ry.^2).*h1./(2*r.^5) + (0.25)*(1i)*(3*k^3).*(rx.^2).*(ry.^2).*h4./(4*r.^5) - ...
       (0.25)*(1i)*(k^3).*(ry.^2).*h1./(2*r.^3) - (0.25)*(1i)*(k^3).*(ry.^2).*h4./(4*r.^3) +...
       (0.25)*(1i)*(k^3).*(-rx.^2).*h1./(2*r.^3) + (0.25)*(1i)*(k^3).*(rx.^2).*(ry.^2).*h1./(2*r.^5)-...
       (0.25)*(1i)*(k^4).*(rx.^2).*(ry.^2).*h3./(4*r.^4) - (0.25)*(1i)*(k^3).*(rx.^2).*h4./(4*r.^3) + ...
       (0.25)*(1i)*(k^3).*(rx.^2).*(ry.^2).*h4./(4*r.^5) -(0.25)*(1i)*(k^4)*(rx.^2).*(ry.^2).*h3./(8*r.^4)+...
       (0.25)*(1i)*(k^4).*(rx.^2).*(ry.^2).*h5./(8*r.^4);

    forth(:, :, 5) = (0.25)*(1i)*(3*k)*(rx.^2).*h1./(r.^5) -(0.25)*(1i)*k.*h1./(r.^3) - ...
       (0.25)*(1i)*15*k.*(rx.^2).*(ry.^2).*(h1)./(r.^7) + (0.25)*(1i)*(3*k).*(ry.^2).*h1./(r.^5)-...
       (0.25)*(1i)*(3*k^2).*(rx.^2).*h3./(2*r.^4) + (0.25)*(1i)*(k^2).*h3./(2*r.^2) +...
       (0.25)*(1i)*15*(k^2).*(rx.^2).*(ry.^2).*h3./(2*r.^6) - (0.25)*(1i)*(3*k^2)*(ry.^2).*h3./(2*r.^4) -...
       ((0.25)*(1i)*(k^3).*(-rx.^2).*(ry.^2).*h1./(r.^5) + (0.25)*(1i)*(k^3).*(-rx.^2).*(ry.^2).*h4./(2*r.^5)) +...
       (0.25)*(1i)*(3*k^3).*(rx.^2).*(ry.^2).*h1./(2*r.^5) + (0.25)*(1i)*(3*k^3).*(rx.^2).*(ry.^2).*h4./(4*r.^5) - ...
       (0.25)*(1i)*(k^3).*(ry.^2).*h1./(2*r.^3) - (0.25)*(1i)*(k^3).*(ry.^2).*h4./(4*r.^3) +...
       (0.25)*(1i)*(k^3).*(-rx.^2).*h1./(2*r.^3) + (0.25)*(1i)*(k^3).*(rx.^2).*(ry.^2).*h1./(2*r.^5)-...
       (0.25)*(1i)*(k^4).*(rx.^2).*(ry.^2).*h3./(4*r.^4) - (0.25)*(1i)*(k^3).*(rx.^2).*h4./(4*r.^3) + ...
       (0.25)*(1i)*(k^3).*(rx.^2).*(ry.^2).*h4./(4*r.^5) -(0.25)*(1i)*(k^4)*(rx.^2).*(ry.^2).*h3./(8*r.^4)+...
       (0.25)*(1i)*(k^4).*(rx.^2).*(ry.^2).*h5./(8*r.^4);

    forth(:, :, 6) = (-0.25)*(1i)*k*((-9*rx.*ry./(r.^5) + 15*rx.*(ry.^3)./(r.^7)).*h1 + 2*k*rx.*(ry).*h3./(r.^4)-...
        k*(-rx./(r.^3) + 3*rx.*(ry.^2)./(r.^5)).*ry.*h3./(2*r) - 4*k*rx.*(ry.^3).*h3./(r.^6) + ...
        k*rx.*(ry).*h3./(2*r.^4) - k*rx.*(ry.^3).*h3./(2*r.^6) - (k^2)*rx.*(ry.^3).*h1./(2*r.^5) - (k^2)*rx.*(ry.^3).*h4./(4*r.^5)-...
        (k^2)*rx.*(ry.^3).*h1./(r.^5) - (k^2)*rx.*(ry.^3).*h4./(2*r.^5) + 3*k*rx.*ry.*h3./(2*r.^4) -...
        3*k*rx.*(ry.^3).*h3./(2*r.^6) + (k^2)*rx.*ry.*h1./(2*r.^3) + (k^2)*rx.*ry.*h4./(4*r.^3) - (k^2)*rx.*(ry.^3).*h1./(2*r.^5)-...
        (k^2)*rx.*(ry.^3).*h4./(4*r.^5) + (k^2)*rx.*(ry).*h1./(2*r.^3) +(k^2)*rx.*ry.*h4./(4*r.^3) - ...
        (k^2)*rx.*(ry.^3).*h1./(2*r.^5) - (k^2)*rx.*(ry.^3).*h4./(4*r.^5) + (k^2)*rx.*ry.*h1./(2*r.^3)-...
        (k^2)*rx.*(ry.^3).*h1./(2*r.^5) +(k^3)*rx.*(ry.^3).*h3./(4*r.^4) + (k^2)*rx.*(ry).*h4./(4*r.^3)-...
        (k^2)*rx.*(ry.^3).*h4./(4*r.^5) - (k^3)*rx.*(-ry.^3).*h3./(8*r.^4) - (k^3)*rx.*(ry.^3).*h5./(8*r.^4));
    
    forth(:, :, 7) = (-0.25)*(1i)*k*((-9*rx.*ry./(r.^5) + 15*rx.*(ry.^3)./(r.^7)).*h1 + 2*k*rx.*(ry).*h3./(r.^4)-...
        k*(-rx./(r.^3) + 3*rx.*(ry.^2)./(r.^5)).*ry.*h3./(2*r) - 4*k*rx.*(ry.^3).*h3./(r.^6) + ...
        k*rx.*(ry).*h3./(2*r.^4) - k*rx.*(ry.^3).*h3./(2*r.^6) - (k^2)*rx.*(ry.^3).*h1./(2*r.^5) - (k^2)*rx.*(ry.^3).*h4./(4*r.^5)-...
        (k^2)*rx.*(ry.^3).*h1./(r.^5) - (k^2)*rx.*(ry.^3).*h4./(2*r.^5) + 3*k*rx.*ry.*h3./(2*r.^4) -...
        3*k*rx.*(ry.^3).*h3./(2*r.^6) + (k^2)*rx.*ry.*h1./(2*r.^3) + (k^2)*rx.*ry.*h4./(4*r.^3) - (k^2)*rx.*(ry.^3).*h1./(2*r.^5)-...
        (k^2)*rx.*(ry.^3).*h4./(4*r.^5) + (k^2)*rx.*(ry).*h1./(2*r.^3) +(k^2)*rx.*ry.*h4./(4*r.^3) - ...
        (k^2)*rx.*(ry.^3).*h1./(2*r.^5) - (k^2)*rx.*(ry.^3).*h4./(4*r.^5) + (k^2)*rx.*ry.*h1./(2*r.^3)-...
        (k^2)*rx.*(ry.^3).*h1./(2*r.^5) +(k^3)*rx.*(ry.^3).*h3./(4*r.^4) + (k^2)*rx.*(ry).*h4./(4*r.^3)-...
        (k^2)*rx.*(ry.^3).*h4./(4*r.^5) - (k^3)*rx.*(-ry.^3).*h3./(8*r.^4) - (k^3)*rx.*(ry.^3).*h5./(8*r.^4));

    forth(:, :, 8) = (-0.25)*(1i)*(3*k)*h1./(r.^3) + 0.25*(1i)*(18*k)*(ry.^2).*h1./(r.^5) - (0.25)*(1i)*(15*k).*(ry.^4).*h1./(r.^7) +...
        (0.25)*(1i)*(3*k^2).*(h3)./(2*r.^2) - (0.25)*(1i)*(9*k^2).*(ry.^2).*h3./(r.^4) + (0.25)*(1i)*(15*k^2).*(ry.^4).*h3./(2*r.^6) +...
        (0.25)*(1i)*(k^3)*(-ry.^2).*h1./(r.^3) - (0.25)*(1i)*(k^3).*(ry.^2).*h4./(2*r.^3) - (0.25)*(1i)*(k^3).*(-ry.^4).*h1./(r.^5) + ...
        (0.25)*(1i)*(k^3)*(ry.^4).*h4./(2*r.^5) - (0.25)*(1i)*(3*k^3).*(ry.^2).*h1./((2*r.^3)) - (0.25)*(1i)*(3*k^3).*(ry.^2).*h4./(4*r.^3) +...
        (0.25)*(1i)*(3*k^3)*(ry.^4).*h1./(2*r.^5) + (0.25)*(1i)*(3*k^3).*(ry.^4).*h4./(4*r.^5) - (0.25)*(1i)*(k^3).*(ry.^2).*h1./(2*r.^3) + ...
        (0.25)*(1i)*(k^3)*(ry.^4).*h1./(2*r.^5) - (0.25)*(1i)*(k^4).*(ry.^4).*h3./(4*r.^4) - (0.25)*(1i)*(k^3).*(ry.^2).*h4./(4*r.^3) + ...
        (0.25)*(1i)*(k^3)*(ry.^4).*h4./(4*r.^5) + (0.25)*(1i)*(k^4).*(-ry.^4).*h3./(8*r.^4) + (0.25)*(1i)*(k^4)*(ry.^4).*h5./(8*r.^4);

end
end

    









